name: Package Potku

on:
  workflow_dispatch:

jobs:  

  package_macos:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          submodules: recursive
      - name: Download C artifact
        uses: dawidd6/action-download-artifact@v2
        with:
          name: c-apps-macos
          workflow: compile_c_apps.yml
          path: ${{runner.workspace}}/potku/external
      - name: Collect external files
        run: |
          mkdir -p ${{runner.workspace}}/potku/external/share/jibal
          curl http://users.jyu.fi/~jaakjuli/jibal/data/data.tar.gz -o data.tar.gz && tar -xvf data.tar.gz -C ${{runner.workspace}}/potku/external/share/jibal
          cd ${{runner.workspace}}/potku/external/share
          curl https://www.jyu.fi/science/en/physics/research/infrastructures/accelerator-laboratory/pelletron/potku/release_versions/potku_mac_20220331.zip/@@download/file/potku_mac_20220331.zip -o potku.zip
          unzip potku.zip 'potku/external/share/srim2013.tot' -d ${{runner.workspace}}/potku/external/share
          mv ${{runner.workspace}}/potku/external/share/potku/external/share/srim2013.tot ${{runner.workspace}}/potku/external/share/srim2013.tot
          rm -r potku
          rm potku.zip
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          # Semantic version range syntax or exact version of a Python version
          python-version: '3.10'
      - name: Package Potku
        run: |
          cd ${{runner.workspace}}/potku
          pip install pipenv
          pipenv install
          pipenv run pip install pyinstaller
          pipenv run pyinstaller potku.spec
      - name: Archive MacOS build
        uses: actions/upload-artifact@v3
        with:
          name: Potku-MacOS
          path: ${{runner.workspace}}/potku/dist
